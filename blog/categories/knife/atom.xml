<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: knife | DevOp's Blog]]></title>
  <link href="http://jakshi.github.com/blog/categories/knife/atom.xml" rel="self"/>
  <link href="http://jakshi.github.com/"/>
  <updated>2015-06-11T14:21:33+08:00</updated>
  <id>http://jakshi.github.com/</id>
  <author>
    <name><![CDATA[jakshi]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Chef shortcuts]]></title>
    <link href="http://jakshi.github.com/blog/2014/11/21/chef-shortcuts/"/>
    <updated>2014-11-21T13:16:00+08:00</updated>
    <id>http://jakshi.github.com/blog/2014/11/21/chef-shortcuts</id>
    <content type="html"><![CDATA[<h1>Add a recipe to the end of run list on certain environment</h1>

<p>Test run, not actually add a recipe:</p>

<p><code>
knife exec -E 'nodes.transform ("chef_environment:beta") {|n| puts n.run_list &lt;&lt; "recipe[logentries_ng]" }'
</code></p>

<p>Add a recipe for real:</p>

<p><code>
knife exec -E 'nodes.transform ("chef_environment:beta") {|n| puts n.run_list &lt;&lt; "recipe[logentries_ng]"; n.save }'
</code></p>

<!-- more -->


<h1>Add a recipe to the beginning of run list on certain environment</h1>

<p>Test run, not actually add a recipe:</p>

<p><code>
knife exec -E 'nodes.transform ("chef_environment:qa01") {|n| old_rl = n.run_list.to_a; puts n.run_list(["recipe[datadog::dd-handler]"] + old_rl) }'
</code></p>

<p>Add a recipe for real:</p>

<p><code>
knife exec -E 'nodes.transform ("chef_environment:qa01") {|n| old_rl = n.run_list.to_a; puts n.run_list(["recipe[datadog::dd-handler]"] + old_rl); n.save }'
</code></p>

<h1>Insert a recipe in the second position of run list on certain environment</h1>

<p>Test run, not actually add a recipe:</p>

<p><code>
knife exec -E 'nodes.transform ("chef_environment:qa04") {|n| old_rl = n.run_list.to_a; puts n.run_list(old_rl[0..0] + ["recipe[datadog::dd-handler]"] + old_rl[1..-1]) }'
</code></p>

<p>Add a recipe for real:</p>

<p><code>
knife exec -E 'nodes.transform ("chef_environment:qa04") {|n| old_rl = n.run_list.to_a; puts n.run_list(old_rl[0..0] + ["recipe[datadog::dd-handler]"] + old_rl[1..-1]); n.save }'
</code></p>

<h1>Remove a recipe from run list on certain environment</h1>

<p>Test run, not actually remove a recipe:</p>

<p><code>
knife exec -E 'nodes.transform ("chef_environment:qa02") {|n| puts n.run_list.remove ("recipe[logentries_ng]") }'
</code></p>

<p>Remove a recipe for real:</p>

<p><code>
knife exec -E 'nodes.transform ("chef_environment:qa02") {|n| puts n.run_list.remove ("recipe[logentries_ng]"); n.save }'
</code></p>

<h1>Execute chef-client on all nodes in specific environment</h1>

<p><code>
knife ssh 'chef_environment:qa02' 'sudo chef-client'
</code></p>

<h1>Search for nodes in specific environment and having specific recipe</h1>

<p>And show only node names (-i option)</p>

<p><code>
knife search node "chef_environment:production AND recipes:web_server" -i
</code></p>

<h1>Get list of all uniq non-system usernames that exists in specific environment</h1>

<p><code>
knife exec -E 'users = []; nodes.find("chef_environment:production") {|n| n[:etc][:passwd].select { |user, options| options[:uid] &gt;= 1000 }.each { |user, options| users &lt;&lt; user} }; users.uniq.each { |user| puts user } '
</code></p>

<h1>More shotcuts</h1>

<p>Do you want even more shortcuts? Read nice article: <a href="http://dougireton.com/blog/2013/02/03/knife-tricks/">Knife Tricks</a></p>
]]></content>
  </entry>
  
</feed>
